<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…ØµÙ…Ù… Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

  <style>
    body {
      font-family: 'Tajawal', Arial, sans-serif;
      text-align: center;
      direction: rtl;
      background-color: #f5f5f5;
      margin: 0;
    }
    .container {
      width: 80%;
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .settings {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 90%;
      max-width: 800px;
      margin: auto;
    }
    .form-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }
    .input-group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .input-group label {
      font-size: 1em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .input-group input {
      padding: 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
    }
    .input-group input[type="color"] {
      height: 40px;
      width: 100%;
      padding: 0;
      border: none;
    }
    .card-preview {
      position: relative;
      width: 300px;
      height: 150px;
      margin: auto;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border: 1px solid #000;
    }
    .draggable {
      position: absolute;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.7);
      padding: 2px 5px;
      cursor: move;
      border-radius: 3px;
    }
    .btn {
      padding: 12px 18px;
      margin: 15px;
      background-color: #0056b3;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
    }
    .btn:hover {
      background-color: #004494;
    }
    #qrHandle {
      width: 15px;
      height: 15px;
      background: #555;
      opacity: 0.5;
      position: absolute;
      bottom: 0;
      right: 0;
      cursor: nwse-resize;
    }
    #qrHandle:hover {
      background: #000;
      opacity: 0.8;
    }
    h3 {
      margin-top: 10px;
      margin-bottom: 10px;
    }
  </style>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
</script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h2>ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø§ØªÙ„- Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©</h2>
	<div class="settings">
  <div class="form-row" style="justify-content: center;">
    <div class="input-group">
      <label for="pdfInput">ğŸ“„ Ø±ÙØ¹ Ù…Ù„Ù PDF:</label><br/>
      <input type="file" id="pdfInput" accept=".pdf" />
    </div>

    <div style="margin-top: 17px; font-weight: bold;">Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ</div>

    <div class="input-group">
      <label for="fileInput">ğŸ“‚ Ø±ÙØ¹ Ù…Ù„Ù Excel:</label><br/>
      <input type="file" id="fileInput" accept=".xlsx, .csv" />
    </div>

    <div class="input-group">
      <label for="imageInput">ğŸ¨ Ø±ÙØ¹ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</label><br/>
      <input type="file" id="imageInput" accept="image/*" />
    </div>
  </div>

  <div class="form-row">
    <div class="input-group">
      <label for="cardsPerPage">ğŸ“„ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª ÙÙŠ Ø§Ù„ØµÙØ­Ø©:</label>
      <input type="number" id="cardsPerPage" value="100" />
    </div>

    <div class="input-group">
      <label for="columnsPerRow">ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:</label>
      <input type="number" id="columnsPerRow" value="5" />
    </div>
  </div>

  <div class="form-row">
    <div class="input-group">
      <label for="textColor">ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ù†Øµ:</label>
      <input type="color" id="textColor" value="#000000" />
    </div>

    <div class="input-group">
      <label for="fontSize">ğŸ”  Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</label>
      <input type="number" id="fontSize" value="11" />
    </div>
  </div>

  <div class="form-row">
    <div class="input-group">
      <label for="domainInput">ğŸŒ IP Ø£Ùˆ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†:</label>
      <input type="text" id="domainInput" placeholder="Ù…Ø«Ø§Ù„: n.ps" />
    </div>

    <div class="input-group" style="flex-direction: row; align-items: center; justify-content: center;">
      <input type="checkbox" id="qrToggle" style="width:20px; height:20px; margin:0 5px;" />
      <label for="qrToggle">Ø¥Ø¸Ù‡Ø§Ø± QR Code</label>
    </div>
  </div>

  <div class="form-row">
    <div class="input-group">
      <label for="dateInput">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</label>
      <input type="date" id="dateInput" />
    </div>

    <div class="input-group" style="flex-direction: row; align-items: center; justify-content: center;">
      <input type="checkbox" id="dateToggle" style="width:20px; height:20px; margin:0 5px;" />
      <label for="dateToggle">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
    </div>
  </div>

  <div class="form-row">
    <div class="input-group">
      <label for="dateColor">ğŸ¨ Ù„ÙˆÙ† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="color" id="dateColor" value="#000000" />
    </div>

    <div class="input-group">
      <label for="dateSize">ğŸ”  Ø­Ø¬Ù… Ø®Ø· Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="number" id="dateSize" value="6" />
    </div>
  </div>

  <div class="single-card-text">Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·</div>

  <div class="form-row">
    <div class="input-group">
      <label for="usernameInput">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
      <input type="text" id="usernameInput" />
    </div>

    <div class="input-group">
      <label for="passwordInput">ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
      <input type="text" id="passwordInput" />
    </div>
  </div>
</div>

<h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨</h3>

<div id="cardPreview" class="card-preview">
  <div id="usernamePreview" class="draggable" style="top: 40px; left: 20px;" title="Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
  <div id="passwordPreview" class="draggable" style="top: 70px; left: 20px;" title="Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
  <div id="datePreview" class="draggable" style="display:none; top: 100px; left: 20px;" title="Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
  <div id="qrPreview" class="draggable" style="display:none; top: 10px; left: 200px;" title="Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ">
    <img id="qrImage" src="" alt="QR Code" style="width: 80px; height: 80px;" />
    <div id="qrHandle"></div>
  </div>
</div>

<button class="btn" id="downloadBtn">ØªØ­Ù…ÙŠÙ„ PDF</button>
<script>
const { jsPDF } = window.jspdf;
let templateImage = null;
let templateImageWidth = 0, templateImageHeight = 0;
let cardsData = [];
let currentUsername = "";
let currentPassword = "";
let currentDateStr = "";
let qrCodeGenerator = null;

const usernameInput = document.getElementById('usernameInput');
const passwordInput = document.getElementById('passwordInput');
const usernamePreview = document.getElementById('usernamePreview');
const passwordPreview = document.getElementById('passwordPreview');
const domainInput = document.getElementById('domainInput');
const qrToggle = document.getElementById('qrToggle');
const dateInput = document.getElementById('dateInput');
const dateToggle = document.getElementById('dateToggle');
const datePreview = document.getElementById('datePreview');
const dateColorInput = document.getElementById('dateColor');
const dateSizeInput = document.getElementById('dateSize');
function getPosition(e) {
  if (e.touches && e.touches.length > 0) {
    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
  return { x: e.clientX, y: e.clientY };
}
function makeDraggable(elem) {
  let offsetX, offsetY;
  let isDragging = false;
  let containerRect;

  function startDrag(e) {
    isDragging = true;
    containerRect = elem.parentElement.getBoundingClientRect();
    const pos = getPosition(e);
    offsetX = pos.x - elem.getBoundingClientRect().left;
    offsetY = pos.y - elem.getBoundingClientRect().top;
    elem.style.cursor = "grabbing";
    e.preventDefault();
  }

  function onDrag(e) {
    if (!isDragging) return;
    const pos = getPosition(e);
    let newLeft = pos.x - containerRect.left - offsetX;
    let newTop = pos.y - containerRect.top - offsetY;

    const container = elem.parentElement;
    const maxLeft = container.clientWidth - elem.clientWidth;
    const maxTop = container.clientHeight - elem.clientHeight;

    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;
    if (newTop > maxTop) newTop = maxTop;

    elem.style.left = newLeft + 'px';
    elem.style.top = newTop + 'px';
  }

  function stopDrag() {
    if (isDragging) {
      isDragging = false;
      elem.style.cursor = "move";
    }
  }

  elem.addEventListener('mousedown', startDrag);
  elem.addEventListener('touchstart', startDrag);

  document.addEventListener('mousemove', onDrag);
  document.addEventListener('touchmove', onDrag);

  document.addEventListener('mouseup', stopDrag);
  document.addEventListener('touchend', stopDrag);
}
makeDraggable(usernamePreview);
makeDraggable(passwordPreview);
makeDraggable(datePreview);
makeDraggable(document.getElementById('qrPreview'));

document.getElementById('imageInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    templateImage = e.target.result;
    const preview = document.getElementById('cardPreview');
    preview.style.backgroundImage = 'url(' + templateImage + ')';
    const img = new Image();
    img.onload = function() {
      templateImageWidth = img.width;
      templateImageHeight = img.height;
      const maxWidth = 300;
      const newWidth = maxWidth;
      const newHeight = Math.round(maxWidth * (templateImageHeight / templateImageWidth));
      preview.style.width = newWidth + 'px';
      preview.style.height = newHeight + 'px';
    };
    img.src = templateImage;
  };
  reader.readAsDataURL(file);
});

document.getElementById('fileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = e.target.result;
      let workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
      const firstSheet = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheet];
      cardsData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
      cardsData = cardsData.filter(row => {
        const val1 = String(row[Object.keys(row)[0]] || "").toLowerCase();
        const val2 = String(row[Object.keys(row)[1]] || "").toLowerCase();
        return !(val1.includes("username") || val2.includes("password"));
      });
      if (cardsData.length > 0) {
        const first = cardsData[0];
        const keys = Object.keys(first);
        usernamePreview.innerText = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + first[keys[0]];
        passwordPreview.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: " + first[keys[1]];
        currentUsername = first[keys[0]];
        currentPassword = first[keys[1]];
      }
    } catch (err) {
      console.error("Excel parsing error:", err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel.");
    }
  };
  reader.readAsArrayBuffer(file);
});
document.getElementById('pdfInput').addEventListener('change', async function(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const typedarray = new Uint8Array(e.target.result);
      const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
      let fullText = "";
      const totalPages = pdf.numPages;
      for (let i = 1; i <= totalPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str).join("\n");
        fullText += strings + "\n";
      }

      // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù†Ù…Ø·ÙŠ (regex) Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙŠÙˆØ²Ø± ÙˆØ§Ù„Ø¨Ø§Ø³ ÙÙ‚Ø·
      const regex = /Username\s+(\d+)\s+Password\s+(\d+)/g;
      let match;
      cardsData = [];
      while ((match = regex.exec(fullText)) !== null) {
        // Ø§Ø­ÙØ¸ Ø§Ù„ÙŠÙˆØ²Ø± ÙˆØ§Ù„Ø¨Ø§Ø³ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
        cardsData.push({ username: match[1], password: match[2] });
      }

      if (cardsData.length > 0) {
        // Ø§Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ Ø³Ø¬Ù„ Ù„Ø§Ø®ØªØ¨Ø§Ø±Ù‡
        const first = cardsData[0];
        usernamePreview.innerText = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + first.username;
        passwordPreview.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: " + first.password;
        currentUsername = first.username;
        currentPassword = first.password;
      } else {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.");
      }
    } catch (err) {
      console.error("PDF Error:", err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF.");
    }
  };
  reader.readAsArrayBuffer(file);
});
function updatePreviewText() {
  if (usernameInput.value.trim() !== "") {
    usernamePreview.innerText = usernameInput.value;
    currentUsername = usernameInput.value;
  } else {
    usernamePreview.innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
    currentUsername = "";
  }
  if (passwordInput.value.trim() !== "") {
    passwordPreview.innerText = passwordInput.value;
    currentPassword = passwordInput.value;
  } else {
    passwordPreview.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
    currentPassword = "";
  }
  if (qrToggle.checked) {
    updateQRCode();
  }
}
usernameInput.addEventListener('input', updatePreviewText);
passwordInput.addEventListener('input', updatePreviewText);

function updateQRCode() {
  if (!qrToggle.checked) return;
  if (!qrCodeGenerator) {
    qrCodeGenerator = new QRious({
      element: document.getElementById('qrImage'),
      size: 80,
      background: 'white',
      foreground: 'black',
      level: 'H',
      value: ''
    });
  }
  const domainVal = domainInput.value.trim();
  if (domainVal === "" || currentUsername === "" || currentPassword === "") {
    qrCodeGenerator.value = "";
  } else {
  let urlDomain = domainVal.endsWith('/') ? domainVal.slice(0, -1) : domainVal;
if (!urlDomain.startsWith("http")) {
  urlDomain = "http://" + urlDomain;
}
    const qrUrl = urlDomain + "/login?username=" + encodeURIComponent(currentUsername) + "&password=" + encodeURIComponent(currentPassword);
    qrCodeGenerator.value = qrUrl;
  }
}

qrToggle.addEventListener('change', e => {
  if (e.target.checked) {
    document.getElementById('qrPreview').style.display = 'block';
    updateQRCode();
  } else {
    document.getElementById('qrPreview').style.display = 'none';
  }
});

domainInput.addEventListener('input', e => {
  if (qrToggle.checked) {
    updateQRCode();
  }
});
dateToggle.addEventListener('change', e => {
  if (e.target.checked) {
    datePreview.style.display = 'block';
    if (dateInput.value) {
      const dd = new Date(dateInput.value);
      const day = String(dd.getDate()).padStart(2, '0');
      const mon = String(dd.getMonth() + 1).padStart(2, '0');
      const yr = dd.getFullYear();
      currentDateStr = `${yr}-${mon}-${day}`;
      datePreview.innerText = currentDateStr;
    } else {
      currentDateStr =
      datePreview.innerText = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©";
    }
  } else {
    datePreview.style.display = 'none';
  }
});

dateInput.addEventListener('change', e => {
  if (e.target.value) {
    const dd = new Date(e.target.value);
    const day = String(dd.getDate()).padStart(2, '0');
    const mon = String(dd.getMonth() + 1).padStart(2, '0');
    const yr = dd.getFullYear();
    currentDateStr = `${yr}-${mon}-${day}`;
    datePreview.innerText = currentDateStr;
  } else {
    currentDateStr = "";
    datePreview.innerText = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©";
  }
});

dateColorInput.addEventListener('input', e => {
  datePreview.style.color = e.target.value;
});

dateSizeInput.addEventListener('input', e => {
  datePreview.style.fontSize = e.target.value + 'px';
});

// ØªØºÙŠÙŠØ± Ø­Ø¬Ù… QR Ø¨Ø§Ù„Ø³Ø­Ø¨
const qrImageElem = document.getElementById('qrImage');
const qrHandle = document.getElementById('qrHandle');
let isResizing = false, startX, startY, startWidth, startHeight;

qrHandle.addEventListener('mousedown', e => {
  e.preventDefault();
  e.stopPropagation();
  isResizing = true;
  startX = e.clientX;
  startY = e.clientY;
  startWidth = qrImageElem.offsetWidth;
  startHeight = qrImageElem.offsetHeight;
});

document.addEventListener('mousemove', e => {
  if (!isResizing) return;
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;
  let d = Math.abs(dx) > Math.abs(dy) ? dx : dy;
  let newWidth = startWidth + d;
  let newHeight = startHeight + d;
  const minSize = 30;
  if (newWidth < minSize || newHeight < minSize) {
    newWidth = newHeight = minSize;
  }
  qrImageElem.style.width = newWidth + 'px';
  qrImageElem.style.height = newHeight + 'px';
});

document.addEventListener('mouseup', e => {
  if (isResizing) {
    isResizing = false;
    const finalSize = qrImageElem.offsetWidth;
    if (qrCodeGenerator) {
      qrCodeGenerator.size = finalSize;
      qrCodeGenerator.value = qrCodeGenerator.value;
    }
  }
});
// Ø¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³ Ù„ØªØºÙŠÙŠØ± Ø­Ø¬Ù… QR
qrHandle.addEventListener('touchstart', e => {
  e.preventDefault();
  e.stopPropagation();
  isResizing = true;
  const touch = e.touches[0];
  startX = touch.clientX;
  startY = touch.clientY;
  startWidth = qrImageElem.offsetWidth;
  startHeight = qrImageElem.offsetHeight;
});

document.addEventListener('touchmove', e => {
  if (!isResizing) return;
  const touch = e.touches[0];
  const dx = touch.clientX - startX;
  const dy = touch.clientY - startY;
  let d = Math.abs(dx) > Math.abs(dy) ? dx : dy;
  let newWidth = startWidth + d;
  let newHeight = startHeight + d;
  const minSize = 30;
  if (newWidth < minSize || newHeight < minSize) {
    newWidth = newHeight = minSize;
  }
  qrImageElem.style.width = newWidth + 'px';
  qrImageElem.style.height = newHeight + 'px';
});

document.addEventListener('touchend', e => {
  if (isResizing) {
    isResizing = false;
    const finalSize = qrImageElem.offsetWidth;
    if (qrCodeGenerator) {
      qrCodeGenerator.size = finalSize;
      qrCodeGenerator.value = qrCodeGenerator.value;
    }
  }
});

document.getElementById('downloadBtn').addEventListener('click', generatePDF);

function generatePDF() {
  if (!templateImage) {
    alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  const dataList = cardsData.length > 0 ? cardsData : [{ username: usernameInput.value.trim(), password: passwordInput.value.trim() }];
  if (dataList[0].username === "" || dataList[0].password === "") {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
    return;
  }
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const marginX = 2;
  const marginY = 2;
  const gapX = 1.1;
  const gapY = 1.1;
  const columns = Number(document.getElementById("columnsPerRow").value) || 1;
  const maxPerPage = Number(document.getElementById("cardsPerPage").value) || dataList.length;
  const cardWidthMm = (pageWidth - 2 * marginX - (columns - 1) * gapX) / columns;
  let cardHeightMm;
  if (templateImageWidth && templateImageHeight) {
    cardHeightMm = (pageHeight - 2 * marginY - (20 - 1) * gapY) / 20;
  } else {
    const previewEl = document.getElementById('cardPreview');
    cardHeightMm = cardWidthMm * (previewEl.clientHeight / previewEl.clientWidth);
  }
  const fontSize = Number(document.getElementById("fontSize").value) || 14;
  const textColor = document.getElementById("textColor").value || "#000000";
  const dateColorVal = dateColorInput.value || "#000000";
  const dateSizeVal = Number(dateSizeInput.value) || 11;

  let xPos = marginX;
  let yPos = marginY;
  let count = 0;

  for (let i = 0; i < dataList.length; i++) {
    const item = dataList[i];
    doc.addImage(templateImage, "PNG", xPos, yPos, cardWidthMm, cardHeightMm);
    const previewW = document.getElementById('cardPreview').clientWidth;
    const previewH = document.getElementById('cardPreview').clientHeight;
    const usernameX = parseFloat(usernamePreview.style.left) || 0;
    const usernameY = parseFloat(usernamePreview.style.top) || 0;
    const passwordX = parseFloat(passwordPreview.style.left) || 0;
    const passwordY = parseFloat(passwordPreview.style.top) || 0;
    const dateX = parseFloat(datePreview.style.left) || 0;
    const dateY = parseFloat(datePreview.style.top) || 0;
    const qrX = parseFloat(document.getElementById('qrPreview').style.left) || 0;
    const qrY = parseFloat(document.getElementById('qrPreview').style.top) || 0;
    const qrW = document.getElementById('qrImage').offsetWidth;
    const qrH = document.getElementById('qrImage').offsetHeight;
    const scaleX = cardWidthMm / previewW;
    const scaleY = cardHeightMm / previewH;

    const userText = String(item.username || item[Object.keys(item)[0]] || "");
    const passText = String(item.password || item[Object.keys(item)[1]] || "");

    doc.setFont("helvetica", "bold");
    doc.setFontSize(fontSize);
    doc.setTextColor(textColor);
    doc.text(userText, xPos + usernameX * scaleX, yPos + usernameY * scaleY);
    doc.text(passText, xPos + passwordX * scaleX, yPos + passwordY * scaleY);

    if (dateToggle.checked && currentDateStr) {
      doc.setFontSize(dateSizeVal);
      doc.setTextColor(dateColorVal);
      doc.text(currentDateStr, xPos + dateX * scaleX, yPos + dateY * scaleY);
      doc.setFontSize(fontSize);
      doc.setTextColor(textColor);
    }

    if (qrToggle.checked) {
	let urlDomain = domainInput.value.trim().endsWith('/') ? domainInput.value.trim().slice(0, -1) : domainInput.value.trim();
if (!urlDomain.startsWith("http")) {
  urlDomain = "http://" + urlDomain;
}
      const qr = new QRious({
        size: 150,
        background: 'white',
        foreground: 'black',
        level: 'H',
        value: urlDomain + "/login?username=" + encodeURIComponent(userText) + "&password=" + encodeURIComponent(passText)
      });
      const qrDataUrl = qr.toDataURL();
      doc.addImage(qrDataUrl, 'PNG', xPos + qrX * scaleX, yPos + qrY * scaleY, qrW * scaleX, qrH * scaleY);
    }

    count++;
    if (count % columns !== 0) {
      xPos += cardWidthMm + gapX;
    } else {
      xPos = marginX;
      yPos += cardHeightMm + gapY;
    }

    if (count % maxPerPage === 0 && i < dataList.length - 1) {
      doc.addPage();
      xPos = marginX;
      yPos = marginY;
      count = 0;
    } else if (yPos + cardHeightMm + marginY > pageHeight) {
      doc.addPage();
      xPos = marginX;
      yPos = marginY;
      count = 0;
    }
  }
  const today = new Date();
  const dateStr = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0');
  const totalCards = dataList.length;
  const fileName = `AL-Nasim.Net_${dateStr}_${totalCards} Ø¨Ø·Ø§Ù‚Ø©.pdf`;
  doc.save(fileName);
}
</script>
<script>
window.addEventListener('DOMContentLoaded', function() {
    // Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯ ÙÙŠ localStorage
    function saveSetting(key, value) {
        localStorage.setItem(key, value);
    }
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
    function loadSettings() {
        const fields = [
            'cardsPerPage', 'columnsPerRow', 'textColor', 'fontSize',
            'domainInput', 'dateColor', 'dateSize', 'usernameInput',
            'passwordInput', 'dateInput'
        ];
        fields.forEach(function(id) {
            const elem = document.getElementById(id);
            if (!elem) return;
            const saved = localStorage.getItem(id);
            if (saved !== null) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ checkboxØŒ Ø¹ÙŠÙ‘Ù† Ø§Ù„Ø­Ø§Ù„Ø© checkedØŒ ÙˆØ¥Ù„Ø§ Ø¹ÙŠÙ‘Ù† Ø§Ù„Ù‚ÙŠÙ…Ø©
                if (elem.type === 'checkbox') {
                    elem.checked = (saved === 'true');
                } else {
                    elem.value = saved;
                }
            }
        });
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ø­ÙØ¸ Ø­Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ QR ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® (checkbox)
        const qrElem = document.getElementById('qrToggle');
        const dateToggleElem = document.getElementById('dateToggle');
        const savedQR = localStorage.getItem('qrToggle');
        if (savedQR !== null) qrElem.checked = (savedQR === 'true');
        const savedDateT = localStorage.getItem('dateToggle');
        if (savedDateT !== null) dateToggleElem.checked = (savedDateT === 'true');
    }
    // Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ (top Ùˆ left)
    function savePositions() {
        const draggableElems = document.querySelectorAll('#cardPreview .draggable');
        const positions = {};
        draggableElems.forEach(function(elem) {
            positions[elem.id] = {
                top: elem.style.top,
                left: elem.style.left
            };
        });
        localStorage.setItem('draggablePositions', JSON.stringify(positions));
    }
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨
    function loadPositions() {
        const saved = localStorage.getItem('draggablePositions');
        if (!saved) return;
        const positions = JSON.parse(saved);
        for (let id in positions) {
            const elem = document.getElementById(id);
            if (elem) {
                elem.style.top = positions[id].top;
                elem.style.left = positions[id].left;
            }
        }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    loadSettings();
    loadPositions();
    // ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    if (typeof updatePreviewText === 'function') {
        updatePreviewText();
    }
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ QR ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    const qrToggleElem = document.getElementById('qrToggle');
    const dateToggleElem = document.getElementById('dateToggle');
    if (qrToggleElem.checked) {
        qrToggleElem.dispatchEvent(new Event('change'));
    }
    if (dateToggleElem.checked) {
        dateToggleElem.dispatchEvent(new Event('change'));
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯
    document.getElementById('cardsPerPage').addEventListener('input', function() {
        saveSetting('cardsPerPage', this.value);
    });
    document.getElementById('columnsPerRow').addEventListener('input', function() {
        saveSetting('columnsPerRow', this.value);
    });
    document.getElementById('textColor').addEventListener('input', function() {
        saveSetting('textColor', this.value);
    });
    document.getElementById('fontSize').addEventListener('input', function() {
        saveSetting('fontSize', this.value);
    });
    document.getElementById('domainInput').addEventListener('input', function() {
        saveSetting('domainInput', this.value);
    });
    document.getElementById('dateColor').addEventListener('input', function() {
        saveSetting('dateColor', this.value);
    });
    document.getElementById('dateSize').addEventListener('input', function() {
        saveSetting('dateSize', this.value);
    });
    document.getElementById('dateInput').addEventListener('change', function() {
        saveSetting('dateInput', this.value);
    });
    document.getElementById('usernameInput').addEventListener('input', function() {
        saveSetting('usernameInput', this.value);
    });
    document.getElementById('passwordInput').addEventListener('input', function() {
        saveSetting('passwordInput', this.value);
    });
    document.getElementById('qrToggle').addEventListener('change', function() {
        saveSetting('qrToggle', this.checked);
    });
    document.getElementById('dateToggle').addEventListener('change', function() {
        saveSetting('dateToggle', this.checked);
    });

    // Ø­ÙØ¸ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³Ø­Ø¨ (mouseup)
    document.addEventListener('mouseup', function() {
        savePositions();
    });
});
</script>
<footer style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #f0f0f0;
    padding: 10px 0;
    font-size: 14px;
    font-weight: bold;
    color: #222;
    font-family: 'Cairo', sans-serif;
    border-top: 1px solid #ccc;
    text-align: center;
    box-sizing: border-box;
">
  <span id="year"></span> Â© ØµØ¯Ù‚Ø© Ø¬Ø§Ø±ÙŠØ© Ø¹Ù† Ø±ÙˆØ­ ÙˆØ§Ù„Ø¯ÙŠ ÙˆØ¬Ù…ÙŠØ¹ Ø£Ù…ÙˆØ§Øª Ø§Ù„Ù…Ø³Ù„Ù…ÙŠÙ†
</footer>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>
</body>
</html>



