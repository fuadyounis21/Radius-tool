<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title class="no-print">مصمم بطاقات الشبكة</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>

<style>
:root{
  --page-w-mm:210; --page-h-mm:297;
  --cols:5; --rows:10;
  --pad-mm:3; --gap-mm:1;
  --cell-w-mm:38mm; --cell-h-mm:25mm;
  --cell-ar: 85.6/54;

  --font-pt:12; --date-pt:8;
  --text-color:#000; --date-color:#000;

  --card-border:0.2mm solid #000; --card-radius:1.2mm;
  --fit:fill;
}
*{box-sizing:border-box}
html,body{margin:0;background:#f6f7fb;color:#0f172a;font-family:'Tajawal',system-ui,Arial}
.container{max-width:1240px;margin:18px auto;padding:0 18px}
.panel{background:#fff;border:1px solid #e6e8ef;border-radius:14px;box-shadow:0 10px 28px rgba(10,15,35,.06)}
.header{padding:14px 16px;border-bottom:1px solid #eef0f5;display:flex;align-items:center;justify-content:space-between}
.header h1{margin:0;font-size:20px;font-weight:900}

.content{display:grid;grid-template-columns:380px 1fr;gap:16px;margin-top:16px}
@media (max-width:1100px){.content{grid-template-columns:1fr}}
.side{display:flex;flex-direction:column;gap:12px}
.card-ui{padding:12px 12px 14px;border:1px solid #eef0f5;border-radius:12px}
.title{margin:0 0 10px;font-size:14px;font-weight:900}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.row6{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
.field{display:flex;flex-direction:column;gap:4px;min-width:0}
label{font-weight:800;font-size:12px;display:flex;align-items:center;gap:6px}
input,select{width:100%;padding:9px 11px;border:1px solid #e2e5ee;border-radius:10px;background:#fff;font-size:13px}
input[type="color"]{padding:2px;height:36px}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
.btn{border:0;border-radius:10px;padding:10px 13px;font-weight:900;cursor:pointer}
.btn.primary{background:#0b61d8;color:#fff}
.btn.dark{background:#1f2937;color:#fff}
.btn.gray{background:#e9eef7}

/* المعاينة */
.previewWrap{padding:14px;display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
.counter{min-width:190px}
.counter .num{font-size:22px;font-weight:900}
.preview{
  width:380px;aspect-ratio:var(--cell-ar);background:#fff;border:var(--card-border);border-radius:var(--card-radius);
  position:relative;overflow:hidden;user-select:none;touch-action:none
}
.bg-img{position:absolute;inset:0;width:100%;height:100%;object-fit:var(--fit);display:none}
.txt{position:absolute;white-space:nowrap;font-weight:800;color:var(--text-color);font-size:calc(var(--font-pt)*1pt)}
.date{font-size:calc(var(--date-pt)*1pt);color:var(--date-color)}
.drag{cursor:grab}.dragging{cursor:grabbing}

/* الصفحات */
.sheets{padding:12px}
.sheet{
  width:calc(var(--page-w-mm)*1mm);height:calc(var(--page-h-mm)*1mm);background:#fff;margin:12px auto;border:1px dashed #e6e8ef;border-radius:10px;
  padding:calc(var(--pad-mm)*1mm);
  display:grid;grid-template-columns:repeat(var(--cols),var(--cell-w-mm));grid-auto-rows:var(--cell-h-mm);
  gap:calc(var(--gap-mm)*1mm);break-after:page
}
.cell{border:var(--card-border);border-radius:var(--card-radius);overflow:hidden;background:#fff;position:relative}
.cell .bg-img{display:block}

/* طباعة (DOM) */
@page{size:A4 portrait;margin:0}
@media print{.no-print{display:none!important} body{background:#fff} .sheet{margin:0;border:0} *{-webkit-print-color-adjust:exact;print-color-adjust:exact}}

/* نافذة الجودة */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
.modal .box{background:#fff;border-radius:14px;min-width:280px;max-width:92vw;padding:14px;border:1px solid #e6e8ef;box-shadow:0 10px 28px rgba(0,0,0,.25)}
.modal h3{margin:0 0 8px;font-size:16px;font-weight:900}
.modal .warn{font-size:12px;color:#374151;background:#fff7ed;border:1px solid #fde68a;padding:8px;border-radius:8px;margin:8px 0}
.modal .opts{display:grid;gap:8px;margin-top:6px}
.modal .opt{display:flex;align-items:center;gap:8px;border:1px solid #eef0f5;border-radius:10px;padding:8px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.modal .btn{padding:9px 12px;border-radius:10px;border:0}
.modal .ok{background:#0b61d8;color:#fff}
.modal .cancel{background:#e9eef7}

/* شريط تقدم الحفظ */
.progress{position:fixed;inset:auto 16px 16px 16px;background:#0f1115;color:#fff;border:1px solid #1b2330;border-radius:14px;padding:14px 16px;display:none;z-index:10000;box-shadow:0 10px 24px rgba(0,0,0,.35)}
.progress-head{display:flex;justify-content:space-between;align-items:center;font-weight:900;margin-bottom:8px}
.progress-bar{width:100%;height:10px;background:#222b3a;border-radius:999px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:#19c37d;transition:width .15s}
.progress-sub{margin-top:8px;font-size:13px;opacity:.95}

.hidden{display:none}
/* شريط سفلي */
.app-footer{
  position:fixed; inset:auto 0 0 0; z-index:9998;
  background:rgba(15,17,21,.88);
  color:#fff; backdrop-filter:blur(8px);
  border-top:1px solid #1b2330;
  padding:10px 14px; text-align:center; font-size:13px; line-height:1.4
}
.app-footer b{font-weight:900}
@media print{ .app-footer{display:none!important} }
/* مساحة أسفل لتجنب التداخل مع الشريط */
body{ padding-bottom:58px }
.page-title{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin-bottom:16px;
}

.designer-badge{
  display:flex;
  align-items:center;
  background:#f1f5f9;
  border-radius:20px;
  padding:6px;
  gap:6px;
  text-decoration:none;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  transition:.3s;
  overflow:hidden;
  max-width:40px; /* فقط الأيقونة بالبداية */
}

.designer-badge img{
  width:20px;
  height:20px;
}

.designer-badge span{
  font-size:13px;
  font-weight:700;
  color:#0b61d8;
  white-space:nowrap;
  opacity:0;
  transition:.3s;
}

/* عند المرور تظهر النص */
.designer-badge:hover,
.designer-badge:focus{
  max-width:300px;
  padding:6px 12px;
}

.designer-badge:hover span,
.designer-badge:focus span{
  opacity:1;
}
</style>
</head>
<body>
<div class="container">
<div class="page-title">
  <h1>مصمم بطاقات شبكات المبادرة</h1>
  <a href="https://wa.me/00972597250160" target="_blank" class="designer-badge">
    <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="واتساب">
    <span>برمجة وتصميم: فؤاد أبو يونس</span>
  </a>
</div>
  <div class="content">
    <div class="side">
      <!-- مصدر البيانات -->
      <div class="panel card-ui">
        <div class="title">مصدر البيانات</div>
        <div class="row">
          <div class="field">
            <label>اختر المصدر</label>
            <select id="dataSource">
              <option value="excel" selected>Excel</option>
              <option value="pdf">PDF</option>
              <option value="manual">يدوي</option>
            </select>
          </div>
          <div class="field">
            <label>إجمالي البطاقات</label>
            <input id="totalCount" value="0" disabled>
          </div>
        </div>
        <div class="row" id="excelRow">
          <div class="field"><label>رفع Excel</label><input id="excel" type="file" accept=".xlsx,.csv"></div>
        </div>
        <div class="row" id="pdfRow" style="display:none">
          <div class="field"><label>رفع PDF</label><input id="pdf" type="file" accept=".pdf"></div>
        </div>
        <div class="row" id="manualRow" style="display:none">
          <div class="field"><label>اسم المستخدم</label><input id="singleUser"></div>
          <div class="field"><label>كلمة المرور</label><input id="singlePass"></div>
          <div class="actions"><button id="addSingle" class="btn gray">إضافة بطاقة</button></div>
        </div>
      </div>

      <!-- نمط التصميم -->
      <div class="panel card-ui">
        <div class="title">نمط التصميم</div>
        <div class="row">
          <div class="field">
            <label>النمط</label>
            <select id="theme">
              <option value="upload" selected>صورة مرفوعة</option>
              <option value="ready1">تصميم جاهز</option>
            </select>
          </div>
          <div class="field">
            <label>ملاءمة الصورة</label>
            <select id="fitMode">
              <option value="fill" selected>ملء كامل</option>
              <option value="contain">احتواء</option>
              <option value="cover">قص</option>
            </select>
          </div>
        </div>
        <div id="uploadBlock" class="row">
          <div class="field"><label>تحميل صورة</label><input id="bg" type="file" accept="image/*"></div>
        </div>
        <div id="readyBlock" class="row" style="display:none">
          <div class="field"><label>اسم الشبكة</label><input id="brand"></div>
          <div class="field"><label>رقم الجوال</label><input id="phone"></div>
        </div>

        <div class="row3">
          <div class="field"><label>لون النص</label><input id="txtColor" type="color" value="#000000"></div>
          <div class="field"><label>حجم الخط pt</label><input id="fontPt" type="number" min="6" max="30" value="12"></div>
          <div class="field" id="borderField"><label>حدود التصميم</label>
            <select id="borderMode">
              <option value="auto" selected>تلقائي</option>
              <option value="on">تشغيل</option>
              <option value="off">إيقاف</option>
            </select>
          </div>
        </div>
      </div>

      <!-- إعدادات الصفحة -->
      <div class="panel card-ui">
        <div class="title">إعدادات الصفحة</div>
        <div class="row6">
          <div class="field"><label>بطاقات/صفحة</label><input id="cardsPerPage" type="number" min="1" value="50"></div>
          <div class="field"><label>أعمدة</label><input id="cols" type="number" min="1" value="5"></div>
          <div class="field"><label>هامش mm</label><input id="pad" type="number" step="0.5" min="0" value="3"></div>
          <div class="field"><label>مسافة mm</label><input id="gap" type="number" step="0.5" min="0" value="1"></div>
          <div class="field"><label>لون التاريخ</label><input id="dateColor" type="color" value="#000000"></div>
          <div class="field"><label>حجم التاريخ pt</label><input id="datePt" type="number" min="6" max="16" value="8"></div>
        </div>

        <div class="row">
          <div class="field"><input id="dateToggle" type="checkbox"><label for="dateToggle">إظهار التاريخ</label></div>
          <div class="field"><label>تاريخ الطباعة</label><input id="dateVal" type="date" disabled></div>
        </div>
      </div>

      <!-- أزرار -->
      <div class="panel card-ui">
        <div class="actions">
          <button id="render" class="btn primary">معاينة الصفحات</button>
          <button id="savePdf" class="btn dark">حفظ PDF</button>
          <button id="clear" class="btn gray">تفريغ</button>
          <button id="resetPos" class="btn gray">مواقع افتراضية</button>
        </div>
      </div>
    </div>

    <!-- المعاينة والصفحات -->
    <div class="panel">
      <div class="previewWrap no-print">
        <div class="counter">
          <div class="title">اسحب العناصر للمعاينة</div>
          <div>إجمالي السجلات</div>
          <div id="count" class="num">0</div>
          <div id="settingsView" style="font-size:13px">50 بطاقة | 5 أعمدة | 10 صفوف</div>
        </div>

        <div id="preview" class="preview">
          <img id="pvBg" class="bg-img" alt="" />
          <div class="txt drag u">اسم المستخدم</div>
          <div class="txt drag p">كلمة المرور</div>
          <div class="txt drag date d" style="display:none">تاريخ</div>
          <div class="txt drag brand" style="display:none;font-weight:900">اسم الشبكة</div>
          <div class="txt drag phone" style="display:none;font-weight:800">0590000000</div>
        </div>
      </div>

      <div id="pagesHost" class="sheets"></div>
    </div>
  </div>
</div>

<!-- نافذة اختيار الجودة -->
<div id="qualityModal" class="modal no-print" role="dialog" aria-modal="true" aria-labelledby="qTitle">
  <div class="box">
    <h3 id="qTitle">اختر الجودة</h3>
    <div class="warn">الجودة الأعلى أوضح لكنها أبطأ وتنتج ملفًا أكبر</div>
    <div class="opts">
      <label class="opt"><input type="radio" name="q" value="1.5" checked> سريع 1.5x</label>
      <label class="opt"><input type="radio" name="q" value="2"> متوازن 2x</label>
      <label class="opt"><input type="radio" name="q" value="3"> عالي 3x</label>
      <label class="opt"><input type="radio" name="q" value="4"> فائق 4x</label>
    </div>
    <div class="actions">
      <button id="qCancel" class="btn cancel">إلغاء</button>
      <button id="qOk" class="btn ok">متابعة</button>
    </div>
  </div>
</div>

<!-- شريط تقدم الحفظ -->
<div id="progress" class="progress no-print" role="status" aria-live="polite">
  <div class="progress-head">
    <div id="progressTitle">حفظ PDF</div>
    <div id="progressPercent">0%</div>
  </div>
  <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
  <div id="progressSub" class="progress-sub">البدء…</div>
</div>

<script>
/* أدوات */
const $=s=>document.querySelector(s);
const setVar=(k,v)=>document.documentElement.style.setProperty(k,v);
const clamp=(n,min,max)=>Math.max(min,Math.min(max,Number(n||0)));
const fmtDate=v=>{if(!v) return ''; const d=new Date(v); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

/* حالة عامة */
let cards=[], bgDataUrl=null;
const state={u:{x:0.04,y:0.14}, p:{x:0.04,y:0.34}, d:{x:0.04,y:0.92}, brand:{x:0.04,y:0.06}, phone:{x:0.04,y:0.80}};
const STORAGE_KEY='cardMakerV1';

/* حدود التصميم: تظهر فقط مع تصميم جاهز */
function applyBorders(){
  const isReady = $('#theme').value === 'ready1';
  const mode = $('#borderMode').value;
  const show = isReady && (mode === 'on' || mode === 'auto');
  setVar('--card-border', show ? '0.2mm solid #000' : '0 solid transparent');
}
function toggleBorderField(){
  const isReady = $('#theme').value === 'ready1';
  $('#borderField').classList.toggle('hidden', !isReady);
}

/* شبكة الصفحة */
function applyGridVars(){
  const cpp=clamp($('#cardsPerPage').value,1,1000);
  const cols=clamp($('#cols').value,1,50);
  const pad=clamp($('#pad').value,0,30);
  const gap=clamp($('#gap').value,0,30);
  const rows=Math.ceil(cpp/cols);
  const wmm=210,hmm=297;
  const cellW=(wmm-2*pad-(cols-1)*gap)/cols;
  const cellH=(hmm-2*pad-(rows-1)*gap)/rows;
  setVar('--cols',cols);setVar('--rows',rows);setVar('--pad-mm',pad);setVar('--gap-mm',gap);
  setVar('--cell-w-mm',cellW+'mm');setVar('--cell-h-mm',cellH+'mm');setVar('--cell-ar',cellW/cellH);
  $('#settingsView').textContent=`${cpp} بطاقة | ${cols} أعمدة | ${rows} صفوف`;
}

/* معاينة */
function placePreview(){
  const pr=$('#preview'), w=pr.clientWidth, h=pr.clientHeight;
  const pos=(el,pt)=>{el.style.left=(pt.x*w)+'px';el.style.top=(pt.y*h)+'px';};
  pos($('.u'),state.u);pos($('.p'),state.p);pos($('.d'),state.d);pos($('.brand'),state.brand);pos($('.phone'),state.phone);
}
function updatePreview(){
  setVar('--fit',$('#fitMode').value);
  setVar('--font-pt',$('#fontPt').value);
  setVar('--text-color',$('#txtColor').value);
  setVar('--date-pt',$('#datePt').value);
  setVar('--date-color',$('#dateColor').value);

  const v=$('#theme').value;
  $('#pvBg').style.display=(v==='upload'&&bgDataUrl)?'block':'none';
  $('#pvBg').src=(v==='upload'&&bgDataUrl)?bgDataUrl:'';

  $('.brand').style.display=(v==='ready1')?'block':'none';
  $('.phone').style.display=(v==='ready1')?'block':'none';

  $('.d').style.display=$('#dateToggle').checked?'block':'none';
  $('.d').textContent=fmtDate($('#dateVal').value)||'';

  applyBorders();
  placePreview();
}

/* سحب العناصر + حفظ الموقع */
function makeDrag(sel,onMove){
  const el=typeof sel==='string'?$(sel):sel; if(!el) return;
  let drag=false,offX=0,offY=0;
  const start=e=>{drag=true;el.classList.add('dragging');const r=el.getBoundingClientRect();
    const x=e.clientX??e.touches?.[0]?.clientX, y=e.clientY??e.touches?.[0]?.clientY;offX=x-r.left;offY=y-r.top;e.preventDefault?.();}
  const move=e=>{if(!drag)return;const pr=$('#preview').getBoundingClientRect();
    const x=e.clientX??e.touches?.[0]?.clientX, y=e.clientY??e.touches?.[0]?.clientY;
    let L=x-pr.left-offX, T=y-pr.top-offY;
    L=Math.max(0,Math.min(L,pr.width-el.offsetWidth)); T=Math.max(0,Math.min(T,pr.height-el.offsetHeight));
    el.style.left=L+'px'; el.style.top=T+'px'; onMove(L,T,pr.width,pr.height); e.preventDefault?.();}
  const end=()=>{drag=false;el.classList.remove('dragging'); saveState(); }
  el.addEventListener('pointerdown',start);window.addEventListener('pointermove',move);window.addEventListener('pointerup',end);
  el.addEventListener('touchstart',start,{passive:false});window.addEventListener('touchmove',move,{passive:false});window.addEventListener('touchend',end);
}
makeDrag($('.u'),(l,t,w,h)=>{state.u.x=l/w;state.u.y=t/h;});
makeDrag($('.p'),(l,t,w,h)=>{state.p.x=l/w;state.p.y=t/h;});
makeDrag($('.d'),(l,t,w,h)=>{state.d.x=l/w;state.d.y=t/h;});
makeDrag($('.brand'),(l,t,w,h)=>{state.brand.x=l/w;state.brand.y=t/h;});
makeDrag($('.phone'),(l,t,w,h)=>{state.phone.x=l/w;state.phone.y=t/h;});

/* بطاقة واحدة */
function buildCell(rec){
  const cell=document.createElement('div');cell.className='cell';

  if($('#theme').value==='upload' && bgDataUrl){
    const img=document.createElement('img');
    img.className='bg-img';
    img.src=bgDataUrl;
    img.style.objectFit=getComputedStyle(document.documentElement).getPropertyValue('--fit').trim();
    cell.appendChild(img);
  }

  if($('#theme').value==='ready1'){
    const b=document.createElement('div');b.className='txt';b.style.left=(state.brand.x*100)+'%';b.style.top=(state.brand.y*100)+'%';b.style.fontWeight='900';b.textContent=$('#brand').value||'';cell.appendChild(b);
    const ph=document.createElement('div');ph.className='txt';ph.style.left=(state.phone.x*100)+'%';ph.style.top=(state.phone.y*100)+'%';ph.style.fontWeight='800';ph.style.fontSize='12px';ph.textContent=$('#phone').value||'';cell.appendChild(ph);
  }

  const u=document.createElement('div');u.className='txt';u.style.left=(state.u.x*100)+'%';u.style.top=(state.u.y*100)+'%';u.textContent=rec.username||'';cell.appendChild(u);
  const p=document.createElement('div');p.className='txt';p.style.left=(state.p.x*100)+'%';p.style.top=(state.p.y*100)+'%';p.textContent=rec.password||'';cell.appendChild(p);

  if($('#dateToggle').checked){
    const d=document.createElement('div');d.className='txt date';d.style.left=(state.d.x*100)+'%';d.style.top=(state.d.y*100)+'%';
    d.textContent=fmtDate($('#dateVal').value)||'';cell.appendChild(d);
  }
  return cell;
}

/* معاينة الصفحات */
async function renderSheets(){
  const cpp=clamp($('#cardsPerPage').value,1,1000);
  applyGridVars();
  $('#pagesHost').innerHTML='';
  if(!cards.length){alert('أضف بيانات أولًا');return;}
  let section=null,inPage=0;
  for(let i=0;i<cards.length;i++){
    if(inPage===0){section=document.createElement('section');section.className='sheet';$('#pagesHost').appendChild(section);}
    section.appendChild(buildCell(cards[i]));
    inPage=(inPage+1)%cpp;
    if((i&31)===0) await new Promise(r=>requestAnimationFrame(()=>r()));
  }
  const remain=cards.length%cpp;
  if(remain&&section){for(let k=remain;k<cpp;k++){const f=document.createElement('div');f.className='cell';f.style.visibility='hidden';section.appendChild(f);}}
}

/* نافذة الجودة */
function askQuality(){
  return new Promise((resolve,reject)=>{
    const modal=$('#qualityModal'); modal.style.display='flex';
    const ok=$('#qOk'), cancel=$('#qCancel');
    const close=()=>{modal.style.display='none'; ok.onclick=null; cancel.onclick=null;}
    cancel.onclick=()=>{close(); reject(new Error('cancel'));};
    ok.onclick=()=>{const sel=document.querySelector('input[name="q"]:checked'); const scale=parseFloat(sel?.value||'1.5'); close(); resolve(scale);};
  });
}

/* شريط التقدم */
const progWrap=$('#progress'), progTitle=$('#progressTitle'), progFill=$('#progressFill'), progPct=$('#progressPercent'), progSub=$('#progressSub');
function showProgress(title,max){ progTitle.textContent=title; progWrap.style.display='block'; updateProgress(0,max,'البدء…'); }
function updateProgress(cur,max,sub){ const pct=max?Math.min(100,Math.round((cur/max)*100)):0; progFill.style.width=pct+'%'; progPct.textContent=pct+'%'; if(sub) progSub.textContent=sub; }
function hideProgress(){ progWrap.style.display='none'; }

/* حفظ PDF */
async function makePdfWithScale(scale){
  if(!document.querySelector('#pagesHost .sheet')) await renderSheets();
  await document.fonts?.ready;
  let JSPDF=(window.jspdf&&window.jspdf.jsPDF)?window.jspdf.jsPDF:window.jsPDF;
  if(!JSPDF){
    await new Promise(res=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js';s.onload=()=>{JSPDF=(window.jspdf&&window.jspdf.jsPDF)?window.jspdf.jsPDF:window.jsPDF;res();};document.head.appendChild(s);});
  }
  const pages=[...document.querySelectorAll('#pagesHost .sheet')];
  showProgress('حفظ PDF', pages.length);

  const doc=new JSPDF({orientation:'p',unit:'mm',format:'a4',compress:true});
  for(let i=0;i<pages.length;i++){
    updateProgress(i, pages.length, `تحويل الصفحة ${i+1}/${pages.length}`);
    const cnv=await html2canvas(pages[i],{scale:scale,useCORS:true,background:'#fff',logging:false,removeContainer:true});
    const img=cnv.toDataURL('image/png');
    doc.addImage(img,'PNG',0,0,210,297);
    if(i<pages.length-1) doc.addPage();
    updateProgress(i+1, pages.length, `إضافة الصفحة ${i+1}/${pages.length}`);
    await new Promise(r=>requestAnimationFrame(()=>r()));
  }
  updateProgress(pages.length, pages.length, 'حفظ الملف...');
  doc.save('cards.pdf');
  hideProgress();
}

/* Excel */
$('#excel').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const wb=XLSX.read(ev.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      const list=[];
      for(const row of rows){
        const joined=row.map(v=>String(v).toLowerCase()).join(' ');
        if(/username/.test(joined)||/password/.test(joined)||/package/.test(joined)) continue;
        const vals=row.map(v=>String(v).trim()).filter(v=>v!=='');
        if(vals.length>=2) list.push({username:vals[0],password:vals[1]});
      }
      if(!list.length){alert('لا بيانات صالحة في Excel');return;}
      cards=cards.concat(list);
      $('#totalCount').value=$('#count').textContent=String(cards.length);
      $('.u').textContent=list[0].username||'اسم المستخدم'; $('.p').textContent=list[0].password||'كلمة المرور';
      updatePreview(); saveState();
    }catch{alert('خطأ قراءة Excel');}
  };
  r.readAsArrayBuffer(f);
});

/* PDF */
$('#pdf').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ev=>{
    try{
      const doc=await pdfjsLib.getDocument({data:new Uint8Array(ev.target.result)}).promise;
      let txt=''; for(let i=1;i<=doc.numPages;i++){const p=await doc.getPage(i);const c=await p.getTextContent();txt+=c.items.map(it=>it.str).join('\n')+'\n';}
      const re=/Username\s+(\S+)\s+Password\s+(\S+)/gi; let m,added=[];
      while((m=re.exec(txt))!==null) added.push({username:m[1],password:m[2]});
      if(!added.length){alert('لا يوجد بيانات مطابقة في PDF');return;}
      cards=cards.concat(added);
      $('#totalCount').value=$('#count').textContent=String(cards.length);
      $('.u').textContent=added[0].username; $('.p').textContent=added[0].password; updatePreview(); saveState();
    }catch{alert('خطأ قراءة PDF');}
  };
  r.readAsArrayBuffer(f);
});

/* صورة الخلفية */
$('#bg').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=ev=>{ bgDataUrl=ev.target.result; $('#pvBg').src=bgDataUrl; updatePreview(); saveState(true); };
  fr.readAsDataURL(f);
});

/* يدوي */
$('#addSingle').addEventListener('click',()=>{
  const u=($('#singleUser')||{}).value?.trim(), p=($('#singlePass')||{}).value?.trim();
  if(!u&&!p) return;
  cards.push({username:u,password:p});
  $('#totalCount').value=$('#count').textContent=String(cards.length);
  $('.u').textContent=u||'اسم المستخدم'; $('.p').textContent=p||'كلمة المرور';
  updatePreview(); saveState();
});

/* أزرار */
$('#render').addEventListener('click',async()=>{ await renderSheets(); window.scrollTo({top:$('#pagesHost').offsetTop,behavior:'smooth'}); });
$('#savePdf').addEventListener('click',async()=>{
  if(!document.querySelector('#pagesHost .sheet')) await renderSheets();
  let scale=1.5;
  try{ scale=await askQuality(); }catch{ return; }
  await makePdfWithScale(scale);
});
$('#clear').addEventListener('click',()=>{
  cards=[]; $('#totalCount').value=$('#count').textContent='0'; $('#pagesHost').innerHTML='';
  saveState();
});
$('#resetPos').addEventListener('click',()=>{
  state.u={x:0.04,y:0.14};state.p={x:0.04,y:0.34};state.d={x:0.04,y:0.92};state.brand={x:0.04,y:0.06};state.phone={x:0.04,y:0.80};
  placePreview(); saveState();
});

/* تبديل واجهة */
$('#dataSource').addEventListener('change',()=>{
  const v=$('#dataSource').value;
  $('#excelRow').style.display=(v==='excel')?'grid':'none';
  $('#pdfRow').style.display  =(v==='pdf')  ?'grid':'none';
  $('#manualRow').style.display=(v==='manual')?'grid':'none';
  saveState();
});
$('#theme').addEventListener('change',()=>{
  const v=$('#theme').value;
  $('#uploadBlock').style.display=(v==='upload')?'grid':'none';
  $('#readyBlock') .style.display=(v==='ready1')?'grid':'none';
  toggleBorderField();
  applyBorders();
  updatePreview();
  saveState();
});
$('#borderMode').addEventListener('change',()=>{applyBorders(); saveState();});
$('#dateToggle').addEventListener('change',()=>{ $('#dateVal').disabled=!$('#dateToggle').checked; updatePreview(); saveState(); });

/* حفظ تلقائي عند تغيير المدخلات */
['input','change'].forEach(evt=>{
  ['cardsPerPage','cols','pad','gap'].forEach(id=>$('#'+id).addEventListener(evt,()=>{applyGridVars();placePreview(); saveState();}));
  ['fitMode','txtColor','fontPt','brand','phone','dateVal','dateColor','datePt'].forEach(id=>$('#'+id).addEventListener(evt,()=>{updatePreview(); saveState();}));
  ['singleUser','singlePass'].forEach(id=>{
    const x=$('#'+id); x&&x.addEventListener(evt,()=>{
      $('.u').textContent=($('#singleUser').value||'').trim()||'اسم المستخدم';
      $('.p').textContent=($('#singlePass').value||'').trim()||'كلمة المرور';
      updatePreview(); saveState();
    });
  });
});
window.addEventListener('resize',placePreview);

/* حفظ/استرجاع الإعدادات */
function collectSettings(){
  return {
    dataSource: $('#dataSource').value,
    theme: $('#theme').value,
    fitMode: $('#fitMode').value,
    txtColor: $('#txtColor').value,
    fontPt: $('#fontPt').value,
    borderMode: $('#borderMode').value,
    cardsPerPage: $('#cardsPerPage').value,
    cols: $('#cols').value,
    pad: $('#pad').value,
    gap: $('#gap').value,
    dateToggle: $('#dateToggle').checked,
    dateVal: $('#dateVal').value,
    dateColor: $('#dateColor').value,
    datePt: $('#datePt').value,
    brand: $('#brand').value,
    phone: $('#phone').value,
    positions: JSON.parse(JSON.stringify(state)),
    bgDataUrl: bgDataUrl && bgDataUrl.length < 2_000_000 ? bgDataUrl : null,
    count: cards.length
  };
}
function applySettings(cfg){
  if(!cfg) return;
  $('#dataSource').value = cfg.dataSource ?? $('#dataSource').value;
  $('#theme').value = cfg.theme ?? $('#theme').value;
  $('#fitMode').value = cfg.fitMode ?? $('#fitMode').value;
  $('#txtColor').value = cfg.txtColor ?? $('#txtColor').value;
  $('#fontPt').value = cfg.fontPt ?? $('#fontPt').value;
  $('#borderMode').value = cfg.borderMode ?? $('#borderMode').value;
  $('#cardsPerPage').value = cfg.cardsPerPage ?? $('#cardsPerPage').value;
  $('#cols').value = cfg.cols ?? $('#cols').value;
  $('#pad').value = cfg.pad ?? $('#pad').value;
  $('#gap').value = cfg.gap ?? $('#gap').value;
  $('#dateToggle').checked = !!cfg.dateToggle;
  $('#dateVal').value = cfg.dateVal ?? '';
  $('#dateColor').value = cfg.dateColor ?? $('#dateColor').value;
  $('#datePt').value = cfg.datePt ?? $('#datePt').value;
  $('#brand').value = cfg.brand ?? '';
  $('#phone').value = cfg.phone ?? '';
  if(cfg.positions){ Object.assign(state, cfg.positions); }
  if(cfg.bgDataUrl){ bgDataUrl = cfg.bgDataUrl; $('#pvBg').src = bgDataUrl; }
  $('#totalCount').value = $('#count').textContent = String(cfg.count ?? cards.length ?? 0);

  const v=$('#dataSource').value;
  $('#excelRow').style.display=(v==='excel')?'grid':'none';
  $('#pdfRow').style.display  =(v==='pdf')  ?'grid':'none';
  $('#manualRow').style.display=(v==='manual')?'grid':'none';

  const th=$('#theme').value;
  $('#uploadBlock').style.display=(th==='upload')?'grid':'none';
  $('#readyBlock') .style.display=(th==='ready1')?'grid':'none';
  toggleBorderField();
}
function saveState(bgChanged=false){
  try{
    const cfg=collectSettings();
    if(!bgChanged) cfg.bgDataUrl = bgDataUrl && bgDataUrl.length < 2_000_000 ? bgDataUrl : null;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
  }catch(e){}
}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const cfg=JSON.parse(raw);
    applySettings(cfg);
  }catch(e){}
}

/* بداية */
loadState();
applyGridVars();
applyBorders();
updatePreview();
placePreview();
</script>
<div class="app-footer no-print">
  <span>هذا العمل <b>صدقة جارية</b> عن روح والدي وجميع أموات المسلمين</span>
</div>
</body>
</html>